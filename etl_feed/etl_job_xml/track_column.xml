<?xml version="1.0"?>
<?xml-stylesheet type="text/css" href="xmlpartsstyle.css"?>
<etl_job xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../src/main/resources/etl_feed_job.xsd">
    <job_static_param>
        <feed_name>tracker_track_columns</feed_name>
        <frequency>HOURLY</frequency>
    </job_static_param>

    <extract>
        <type>JSON</type>
        <format_file_name>true</format_file_name>
        <file_initial_path>/data-raw/kafka</file_initial_path>
        <file_name_pattern>track_%s_json</file_name_pattern>
    </extract>

    <transform>
        <rule order='1' type='PARTITION' group='1' scope="MERGE"><condition>records is not null</condition></rule>

        <rule order='2' type='EXPLODE' group='11'><condition>records</condition></rule>
        <rule order='2' type='SCHEMA_TRANSFORMATION' group='12' failed_field_limit="40" failed_row_limit="50">
            <field_mapping source_name="timestamp" target_name="client_timestamp"/>
        </rule>

        <rule order='3' type='SCHEMA_TRANSFORMATION' group='11' failed_field_limit="40" failed_row_limit="50">
            <condition>records.value</condition>
            <field_mapping source_name="timestamp" target_name="client_timestamp"/>
        </rule>
        <rule order='3' type='NIL' group='12'/>

        <rule order='4' type='MERGE' group='1' merge_group='11,12'/>
    </transform>

    <load>
        <type>HIVE</type>
        <db_name>abhishesharma</db_name>
        <task>tracker_track_columns</task>
        <table_name>track_columns</table_name>
        <file_type>PARQUET</file_type>
        <partition_data>
            <coalesce_partition>false</coalesce_partition>
            <overwrite_partition>true</overwrite_partition>
            <partition_file_initial_path>/user/abhishesharma</partition_file_initial_path>
            <partition_columns>
                <column name="year" value="YEAR"/>
                <column name="month" value="MONTH"/>
                <column name="day" value="DAY"/>
                <column name="hour" value="HOUR"/>
                <column name="venture" value="VENTURE"/>
            </partition_columns>
        </partition_data>
    </load>
</etl_job>